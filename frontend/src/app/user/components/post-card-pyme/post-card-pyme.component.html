<div class="container">

  <!-- Spinner de carga -->
  <div class="col-12 text-center" *ngIf="this.publicaciones?.length === 0; else allPublicacionesTemplate">
    <div class="container mt-5">
      <div class="spinner-border text-primary text-center my-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <br>
    </div>
  </div>

  <ng-template #allPublicacionesTemplate>

    <!-- Barra de paginación -->
    <div class="row">
      <div class="d-flex justify-content-center">
        <ngb-pagination [collectionSize]="numElement" [(page)]="page" [boundaryLinks]="true"
          (pageChange)="selectPage($event)">
          <ng-template ngbPaginationPages let-page let-pages="pages">
            <li class="ngb-custom-pages-item" *ngIf="pages.length > 0">
              <div class="mb-3 d-flex flex-nowrap px-2">
                <label id="paginationInputLabel" for="paginationInput" class="col-form-label me-2 ms-1">Page</label>
                <input #i type="text" inputmode="numeric" pattern="[0-9]*" class="form-control custom-pages-input"
                  id="paginationInput" [value]="page" (keyup.enter)="selectPage(+i.value)" (blur)="selectPage(+i.value)"
                  (input)="formatInput($event.target)" aria-labelledby="paginationInputLabel paginationDescription"
                  style="width: 2.5rem" />
                <span id="paginationDescription" class="col-form-label text-nowrap px-2"> of {{pages.length}}</span>
              </div>
            </li>
          </ng-template>
        </ngb-pagination>
      </div>
    </div>

    <!-- Targeta de publicaciones -->
    <div class="row justify-content-center px-3">
      <div class="col-sm-12 col-md-6 col-lg-4 col-xl-4">
        <div *ngFor="let item of publicaciones; let i = index">

          
            <div class="card shadow-sm rounded mb-2">

              <div class="card-header pt-2">
                <h6 class="dateHeader text-muted"> <strong class="">Id publicación:</strong> {{item.id}}</h6>
                <!-- TODO ARREGLAR LA CANTIDAD DE OFERTAS QUE HA RECIBIDO ESTA PUBLICACION -->

                <!-- [ngClass]="{'alert-primary' : item.ofertasRecibidas ===, 'alert-warning' : item.ofertasRecibidas.includes('ofertas recibidas')}" -->
                
                <h6 class="stateHeader float-end alert m-0 p-1" role="alert"
                >{{item.cantidadOfertasRecibidas}}</h6>
              </div>

              <div class="card-body">
                <h5 class="card-title"><a class="card-link">{{item.titulo | uppercase}}</a></h5>
                <p class="card-text">{{item.descripcion | uppercase}}</p>

                <hr style="height: 3px;">

                <table class="table table-hover table-borderless">
                  <tbody>
                    <tr>
                      <td colspan="2" class="start-*"><strong>Monto Disponible</strong></td>
                      <td class="text-end">{{item.precioTotal | currency : 'CLP'}}</td>
                    </tr>
                    <tr>
                      <td colspan="2" class="start-*"><strong>Empresa</strong></td>
                      <td class="text-end">{{item.Usuario.Pyme.nombrePyme | titlecase}}</td>
                    </tr>
                    <tr>
                      <td colspan="2" class="start-*"><strong>Propietario</strong></td>
                      <td class="text-end">{{item.Usuario.nombreUsuario | titlecase}} {{item.Usuario.apellidos |
                        titlecase}}</td>
                    </tr>
                    <!-- <tr>
                      <td colspan="2" class="start-*"><strong>Calificación</strong></td>
                      <td class="text-end">{{item.Usuario.Calificacions[i].promedio}}</td>
                    </tr> -->
                  </tbody>
                </table>


              </div>

              <div class="card-footer containerMoreInformation">

                <button class="btn btn-primary text-center" type="button" data-bs-toggle="collapse"
                  [attr.data-bs-target]="'#collapseExample' + i" aria-expanded="false" aria-controls="collapseExample">
                  Más información
                  <img src="../../../../assets/icons/more-information.svg" alt="more-information.svg"
                    class="icon-white">
                </button>

                <div class="cardAccordion collapse mt-2" [attr.id]="'collapseExample' + i">
                  <div class="card card-body col-12">
                    <h4 class="text-center my-2">Detalles de la publicación</h4>
                    <table class="table table-hover table-borderless">
                      <tbody>
                        <tr>
                          <td colspan="2" class="start-*"><strong>Fecha creación</strong></td>
                          <td class="text-end">{{item.createdAt | date : 'dd MMMM yyyy'}}</td>
                        </tr>
                        <tr *ngIf="item.fechaInicioServicio">
                          <td colspan="2" class="start-*"><strong>Fecha de inicio servicio</strong></td>
                          <td class="text-end">{{item.fechaInicioServicio | date : 'dd MMMM yyyy'}}</td>
                        </tr>
                        <tr *ngIf="item.fechaFinServicio">
                          <td colspan="2" class="start-*"><strong>Fecha de término servicio</strong></td>
                          <td class="text-end">{{item.fechaFinServicio | date : 'dd MMMM yyyy'}}</td>
                        </tr>
                        <tr>
                          <td colspan="2" class="start-*"><strong>Garantía</strong></td>
                          <td class="text-end">{{item.garantia.toString() | i18nSelect:garantiaMapa}}</td>
                        </tr>
                        <tr *ngIf="item.aniosGarantia">
                          <td colspan="2" class="start-*"><strong>Años de garantía</strong></td>
                          <td class="text-end">{{item.aniosGarantia | number }}</td>
                        </tr>
                        <tr *ngIf="item.cantidadElementos">
                          <td colspan="2" class="start-*"><strong>Cantidad</strong></td>
                          <td class="text-end">{{item.cantidadElementos}}</td>
                        </tr>
                        <tr *ngIf="item.modelo">
                          <td colspan="2" class="start-*"><strong>Modelo</strong></td>
                          <td class="text-end">{{item.modelo}}</td>
                        </tr>
                        <tr *ngIf="item.color">
                          <td colspan="2" class="start-*"><strong>Color</strong></td>
                          <td class="text-end">{{item.color | titlecase}}</td>
                        </tr>
                      </tbody>
                    </table>

                    <div class="container p-0 text-center">
                      <div class="col-md-4 col-sm-12">
                        <h3 class="fs-6">Archivos adjuntos</h3>
                        <img class="d-block mx-auto" width="50"
                          src="../../../../assets/icons/file-earmark-arrow-down.svg" alt="ile-earmark-arrow-down.svg">
                        <button class="btn btn-secondary btn-sm my-2" type="button">Descargar</button>
                      </div>
                    </div>

                    <div *ngIf="isIdsIguales(item.UsuarioId)" class="container">
                      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-lg btn-success" type="button" data-bs-toggle="modal"
                          data-bs-target="#exampleModal">Ofertar
                        </button>
                      </div>

                      <!-- Modal para ofertar-->
                      <form [formGroup]="formularioOferta" (ngSubmit)="enviarOferta(item.id)">
                        <div class="modal fade" id="exampleModal" data-bs-backdrop="static" tabindex="-1"
                          aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                              <div class="modal-header">
                                <!-- <h5 class="modal-title" id="exampleModalLabel">Escribe una oferta</h5> -->
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                  aria-label="Close"></button>
                              </div>

                              <div class="modal-body">
                                <div class="container">

                                  <!-- FORMULARIO PARA ENVIAR EL MANSAJE DE OFERTA -->
                                  <div class="col-md-12">
                                    <h3 class="fs-5 mb-2">Escribe tu propuesta y empieza a colaborar con esta empresa.
                                    </h3>
                                    <label for="descriptionPublication" class="form-label mb-0">Mensaje</label>
                                    <textarea pInputTextarea class="form-control" formControlName="mensaje"
                                      id="descriptionPublication"></textarea>
                                    <span *ngIf="campoInvalido('mensaje')" class="form-text text-danger">
                                      El mensaje es obligatorio.
                                    </span>
                                  </div>
                                  <br>
                                  <div class="col-md-12" style="width: 300px;">
                                    <label for="maximumPrice" class="form-label mb-0 d-block">Precio de oferta</label>
                                    <div class="p-inputgroup">
                                      <span class="p-inputgroup-addon">$</span>
                                      <p-inputNumber inputId="maximumPrice" mode="decimal" locale="es-CH" currency="CLP"
                                        formControlName="precioOferta"></p-inputNumber>
                                    </div>
                                    <span *ngIf="campoInvalido('precioOferta')" class="form-text d-block text-danger">
                                      El precio es obligatorio.
                                    </span>
                                  </div>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="submit" class="btn btn-primary" data-bs-dismiss="modal"
                                  [disabled]="formularioOferta.invalid">Enviar
                                  oferta</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </form>

                    </div>


                  </div>
                </div>
              </div>
            </div>
            <br>
          

        </div>
      </div>
    </div>

    <!-- Barra de paginación -->
    <div class="row">
      <div class="d-flex justify-content-center">
        <ngb-pagination [collectionSize]="numElement" [(page)]="page" [boundaryLinks]="true"
          (pageChange)="selectPage($event)">
          <ng-template ngbPaginationPages let-page let-pages="pages">
            <li class="ngb-custom-pages-item" *ngIf="pages.length > 0">
              <div class="mb-3 d-flex flex-nowrap px-2">
                <label id="paginationInputLabel" for="paginationInput" class="col-form-label me-2 ms-1">Page</label>
                <input #i type="text" inputmode="numeric" pattern="[0-9]*" class="form-control custom-pages-input"
                  id="paginationInput" [value]="page" (keyup.enter)="selectPage(+i.value)" (blur)="selectPage(+i.value)"
                  (input)="formatInput($event.target)" aria-labelledby="paginationInputLabel paginationDescription"
                  style="width: 2.5rem" />
                <span id="paginationDescription" class="col-form-label text-nowrap px-2"> of {{pages.length}}</span>
              </div>
            </li>
          </ng-template>
        </ngb-pagination>
      </div>
    </div>

  </ng-template>
</div>